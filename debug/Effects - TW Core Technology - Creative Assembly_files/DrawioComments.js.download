(function(){var f=null;var e="$$RES$$ ";var c="$$PREV_VER$$";var g='{"'+c+'": [';var d="$$DELETED$$";var a="commentsAttVerIndex";var b=window.DrawioProperties!=null?DrawioProperties.contextPath:AJS.contextPath();EditorUi.prototype.getCurrentUser=function(){if(f==null){$.ajax({url:b+"/rest/api/user/current",type:"GET",success:function(h){f=new DrawioUser(h.userKey,h.username,h.displayName,h.profilePicture.path)},error:function(h){},dataType:"json"});return new DrawioUser(Date.now(),null,"Anonymous")}return f};EditorUi.prototype.commentsSupported=function(){return true};EditorUi.prototype.canReplyToReplies=function(){return false};EditorUi.prototype.toDrawioComment=function(r,h,k,n){var l=k.history.createdBy;var o=new DrawioComment({id:r,ver:h,ui:this},k.id,decodeURIComponent(k.body.storage.value),k.version.when,k.history.createdDate,false,new DrawioUser(l.userKey,l.username,l.displayName,l.profilePicture.path));o.parentId=n;o.version=k.version.number;if(o.content==d){o.content=mxResources.get("msgDeleted");o.isLocked=true}var p=k.children!=null?k.children.comment.results:[];for(var m=0;m<p.length;m++){var j=this.toDrawioComment(r,h,p[m],k.id);o.addReplyDirect(j);var q=j.content.indexOf(e)==0;if(q){j.content=j.content.substring(e.length);o.isResolved=m==(p.length-1)}}return o};EditorUi.prototype.getContentProperty=function(k,i,j,h){$.ajax({url:b+"/rest/api/content/"+k+"/property?limit=200&expand=version",type:"GET",success:function(l){var m=l.results.filter(function(n){return n.key==i});if(m.length>0){j(m[0])}else{h({status:404,responseText:'{"statusCode":404,"message":"com.atlassian.confluence.api.service.exceptions.NotFoundException"}'})}},error:h,dataType:"json"})};EditorUi.prototype.setContentProperty=function(n,k,h,j,m,i){var l={value:h};if(j){l.version={number:j+1,minorEdit:true}}else{l.key=k}$.ajax({url:b+"/rest/api/content/"+n+"/property"+(j?"/"+encodeURIComponent(k)+"?expand=version":""),type:j?"PUT":"POST",data:JSON.stringify(l),success:m,error:i,dataType:"json",contentType:"application/json"})};EditorUi.prototype.setCommentsAttVersIndex=function(h,i){this.setContentProperty(h,a,JSON.stringify(i),this.curCommentIndexVer,mxUtils.bind(this,function(j){this.curCommentIndexVer=j.version.number}),function(){})};EditorUi.prototype.getCommentsAttVersIndex=function(h,j,i){this.getContentProperty(h,a,mxUtils.bind(this,function(m){this.curCommentIndexVer=m.version.number;try{this.curCommentIndex=JSON.parse(m.value);var k=this.editor.attachmentInfo;if(k&&this.curCommentIndex.length>k.revision){this.curCommentIndex=[]}}catch(l){this.curCommentIndex=[]}j(this.curCommentIndex)}),mxUtils.bind(this,function(){this.curCommentIndex=[];i()}))};EditorUi.prototype.getAttVersWithComments=function(o,h,p,n){var i=1;var l=[],k={};function m(q,s,y,v){var r=0,w=s-q+1;function x(){r++;if(r==w){y()}}function u(z){$.ajax({url:b+"/rest/api/content/"+o+"/child/comment?limit=200&parentVersion="+z,type:"GET",success:function(A){if(A.results.length>0){l.push(z);k[z]=true}x()},error:v})}for(var t=q;t<=s;t++){u(t)}}function j(){if(i>h){p(l,k);return}m(i,Math.min(i+4,h),j,n);i+=5}j()};EditorUi.prototype.getComments=function(r,o,h,j){function q(u){if(u.children!=null){var t=u.children.comment.results.pop();if(t!=null&&decodeURIComponent(t.body.storage.value).indexOf(e)==0){return true}else{return false}}else{return false}}var m=this.editor.attachmentInfo;var i=[],l;if(m&&m.attachmentId){var p=m.attachmentId;h=h||m.revision;this.getCommentsAttVersIndex(p,function(t){l=t.length;k();n()},function(){if(j){r(false);return}n(function(t){l=t.length;k()},o)});var n=mxUtils.bind(this,function(u,t){if(j&&u==null){return}this.getAttVersWithComments(p,h,mxUtils.bind(this,function(v,x){var y=0;for(var w=0;w<this.curCommentIndex.length;w++){if(x[this.curCommentIndex[w]]){y++}}if(y!=v.length||this.curCommentIndex.length!=v.length){this.curCommentIndex=v;this.setCommentsAttVersIndex(p,v)}if(u){u(this.curCommentIndex)}}),function(){console.log("Error while checking integrity of comments index for "+h);if(t){t()}})});var s=mxUtils.bind(this,function(t,v,u){$.ajax({url:b+"/rest/api/content/"+p+"/child/comment?limit=200&expand=body.storage,version,history,children.comment.body.storage,children.comment.version,children.comment.history&parentVersion="+t,type:"GET",success:mxUtils.bind(this,function(y){y=y.results;for(var x=0;x<y.length;x++){var w=decodeURIComponent(y[x].body.storage.value);if(w.indexOf(g)==0){$.ajax({url:b+"/rest/api/content/"+y[x].id,type:"DELETE"});continue}if(j){if(!q(y[x])){r(true);return}}else{var z=this.toDrawioComment(p,t,y[x]);i.push(z)}}v()}),error:u,dataType:"json"})});var k=mxUtils.bind(this,function(){l--;if(l<0){r(j?false:i);return}s(this.curCommentIndex[l],k,o)})}else{o({message:mxResources.get("saveDiagramFirst",null,"Save diagram first!")})}};EditorUi.prototype.hasUnresolvedComments=function(i,h){this.getComments(i,h,null,true)};EditorUi.prototype.addComment=function(l,k,j){var i=this.editor.attachmentInfo;if(i&&i.attachmentId){var h=i.attachmentId;$.ajax({url:b+"/rest/api/content",type:"POST",data:JSON.stringify({type:"comment",container:{type:"attachment",id:h},body:{storage:{value:encodeURIComponent(l.content),representation:"storage"}}}),success:mxUtils.bind(this,function(m){l.version=m.version.number;k(m.id);if(this.curCommentIndex.indexOf(i.revision)==-1){this.curCommentIndex.push(i.revision);this.setCommentsAttVersIndex(h,this.curCommentIndex)}}),error:j,dataType:"json",contentType:"application/json"})}else{j({message:mxResources.get("saveDiagramFirst",null,"Save diagram first!")})}};EditorUi.prototype.newComment=function(j,i){var h=this.editor.attachmentInfo||{};return new DrawioComment({id:h.attachmentId,ver:h.revision,ui:this},null,j,Date.now(),Date.now(),false,i)};EditorUi.prototype.canComment=function(){return true};DrawioComment.prototype.addReply=function(l,s,p,t,k){var n=null;var q=this.file.id;var i=this.file.ver;var m=this.id;var r=this.file.ui;function h(u,v){$.ajax({url:b+"/rest/files/1.0/files/"+q+"/comments/"+m+"?attachmentVersion="+i,type:"PUT",data:JSON.stringify({resolved:u}),success:v,error:p,dataType:"json",contentType:"application/json"})}function o(u){if(r.editor.attachmentInfo.revision!=i){j(u);return}$.ajax({url:b+"/rest/api/content",type:"POST",data:JSON.stringify({type:"comment",ancestors:[{id:m}],container:{type:"attachment",id:q},body:{storage:{value:encodeURIComponent((t?e:"")+l.content),representation:"storage"}}}),success:function(v){l.version=v.version.number;n=v.id;u()},error:function(v){if(v.responseText.indexOf("messageKey=parent.comment.does.not.exist")>0){p({message:mxResources.get("parentCommentDel",null,"Parent comment has been deleted. A reply cannot be added.")})}else{p(v)}},dataType:"json",contentType:"application/json"})}function j(u){$.ajax({url:b+"/rest/files/1.0/files/"+q+"/comments?attachmentVersion="+i,type:"POST",data:JSON.stringify({parentId:m,commentBody:encodeURIComponent((t?e:"")+l.content)}),success:function(v){l.version=v.version.number;l.file.ver=i;n=v.id;u()},error:function(v){if(v.status==404){p({message:mxResources.get("parentCommentDel",null,"Parent comment has been deleted. A reply cannot be added.")})}else{p(v)}},dataType:"json",contentType:"application/json"})}if(t){o(function(){h(true,function(){s(n)})})}else{if(k){h(false,function(){o(function(){s(n)})})}else{o(function(){s(n)})}}};DrawioComment.prototype.editComment=function(h,j,i){this.content=h;$.ajax({url:b+"/rest/api/content/"+this.id,type:"PUT",data:JSON.stringify({type:"comment",body:{storage:{value:encodeURIComponent(h),representation:"storage"}},container:{type:"attachment",id:this.file.id},version:{number:this.version+1}}),success:mxUtils.bind(this,function(k){this.version=k.version.number;j()}),error:i,dataType:"json",contentType:"application/json"})};DrawioComment.prototype.deleteComment=function(k,j){function i(l){$.ajax({url:b+"/rest/api/content/"+l,type:"DELETE",success:k,error:j,dataType:"json"})}var h=this.replies!=null?this.replies.length:0;if(h==0){i(this.id)}else{this.editComment(d,function(){k(true)},j)}};EditorUi.prototype.getCurrentUser()})();